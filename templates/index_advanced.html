<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You Got Options - Advanced Trading Platform</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.socket.io/4.0.0/socket.io.min.js"></script>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#0a0a0a">
</head>
<body>
    <div class="container">
        <!-- Header with Dynamic Market Status -->
        <header class="header">
            <h1 class="title">YOU GOT OPTIONS</h1>
            <p class="subtitle" id="dynamicSubtitle">Advanced Trading Platform</p>
            
            <div id="marketStatus" class="market-status">
                <span id="marketStatusText">Loading market status...</span>
                <div id="nextSessionInfo" class="next-session"></div>
            </div>
            
            <div class="interface-mode-indicator" id="interfaceModeIndicator">
                <span id="modeText">Loading...</span>
            </div>
            
            <div class="accent-line"></div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="tab-navigation">
            <button class="tab-btn active" onclick="switchTab('dashboard')" id="dashboardTab">
                <span class="tab-icon">üìä</span>
                <span class="tab-label">Dashboard</span>
            </button>
            <button class="tab-btn" onclick="switchTab('analysis')" id="analysisTab">
                <span class="tab-icon">üîç</span>
                <span class="tab-label">Analysis</span>
            </button>
            <button class="tab-btn" onclick="switchTab('monitor')" id="monitorTab">
                <span class="tab-icon">üìà</span>
                <span class="tab-label">Live Monitor</span>
            </button>
            <button class="tab-btn" onclick="switchTab('portfolio')" id="portfolioTab">
                <span class="tab-icon">üíº</span>
                <span class="tab-label">Portfolio</span>
            </button>
        </nav>

        <!-- Dashboard Tab -->
        <section id="dashboardTab-content" class="tab-content active">
            <!-- Pre-Market Dashboard (Shows before 9:30 AM ET) -->
            <div id="preMarketDashboard" class="dashboard-section hidden">
                <div class="result-card">
                    <h2>üåÖ Pre-Market Analysis & Watchlist</h2>
                    <div class="pre-market-status">
                        <div class="status-indicator" id="preMarketStatusIndicator">
                            <span id="preMarketCountdown"></span>
                        </div>
                        <button class="refresh-btn" onclick="refreshPreMarketData()" id="refreshPreMarketBtn">
                            üîÑ Refresh Scan
                        </button>
                    </div>
                    
                    <div id="preMarketWatchlist" class="watchlist-grid">
                        <!-- Pre-market stocks will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Live Trading Dashboard (Shows during market hours) -->
            <div id="liveTradingDashboard" class="dashboard-section hidden">
                <div class="result-card">
                    <h2>üö® Live Market Opportunities</h2>
                    <div class="live-status">
                        <div class="status-indicator live-indicator">
                            <span class="pulse-dot"></span>
                            Market Open - Live Data
                        </div>
                        <button class="refresh-btn" onclick="findTodaysOpportunities()" id="findOpportunitiesBtn">
                            ‚ö° Find Today's Plays
                        </button>
                    </div>
                    
                    <div id="liveOpportunities" class="opportunities-grid">
                        <!-- Live opportunities will be populated here -->
                    </div>
                </div>
            </div>

            <!-- After-Hours Dashboard -->
            <div id="afterHoursDashboard" class="dashboard-section hidden">
                <div class="result-card">
                    <h2>üìã Plan Tomorrow's Trades</h2>
                    <div class="after-hours-status">
                        <div class="status-indicator">
                            <span id="nextOpenCountdown"></span>
                        </div>
                    </div>
                    
                    <div class="planning-tools">
                        <div class="tool-card" onclick="switchTab('analysis')">
                            <h3>üìà Stock Analysis</h3>
                            <p>Research and analyze individual stocks</p>
                        </div>
                        <div class="tool-card" onclick="loadMarketSummary()">
                            <h3>üìä Market Review</h3>
                            <p>Review today's market performance</p>
                        </div>
                        <div class="tool-card" onclick="switchTab('portfolio')">
                            <h3>üíº Portfolio Review</h3>
                            <p>Check your trading performance</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Analysis Tab -->
        <section id="analysisTab-content" class="tab-content">
            <div class="result-card">
                <h2>üîç Advanced Stock Analysis</h2>
                
                <!-- Analysis Input Form -->
                <div class="form">
                    <div class="input-row">
                        <div class="input-group">
                            <label for="analysisTickerInput">Stock Ticker</label>
                            <input type="text" id="analysisTickerInput" placeholder="e.g., AAPL, TSLA" maxlength="10">
                        </div>
                        <div class="input-group">
                            <label for="analysisBudgetInput">Budget (Optional)</label>
                            <input type="number" id="analysisBudgetInput" placeholder="e.g., 5000" min="100" step="100">
                        </div>
                        <button class="analyze-btn" onclick="performAdvancedAnalysis()">
                            ANALYZE STOCK
                        </button>
                    </div>
                    
                    <div class="quick-analysis-buttons">
                        <button class="quick-btn" onclick="findTradingOpportunities()">Find Top Opportunities</button>
                        <button class="quick-btn" onclick="analyzePopularStock('AAPL')">Analyze AAPL</button>
                        <button class="quick-btn" onclick="analyzePopularStock('TSLA')">Analyze TSLA</button>
                        <button class="quick-btn" onclick="analyzePopularStock('SPY')">Analyze SPY</button>
                    </div>
                </div>
                
                <!-- Analysis Results -->
                <div id="analysisResults" class="analysis-results hidden">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </section>

        <!-- Live Monitor Tab -->
        <section id="monitorTab-content" class="tab-content">
            <div class="result-card">
                <h2>üìà Live Trade Monitor</h2>
                
                <!-- Add Trade Form -->
                <div class="add-trade-section">
                    <h3>Start Monitoring a Trade</h3>
                    <div class="form">
                        <div class="input-row">
                            <div class="input-group">
                                <label for="monitorSymbol">Symbol</label>
                                <input type="text" id="monitorSymbol" placeholder="AAPL" maxlength="10">
                            </div>
                            <div class="input-group">
                                <label for="monitorOptionType">Type</label>
                                <select id="monitorOptionType">
                                    <option value="STOCK">Stock</option>
                                    <option value="CALL">Call Option</option>
                                    <option value="PUT">Put Option</option>
                                </select>
                            </div>
                            <div class="input-group">
                                <label for="monitorEntryPrice">Entry Price</label>
                                <input type="number" id="monitorEntryPrice" placeholder="150.00" step="0.01" min="0.01">
                            </div>
                            <div class="input-group">
                                <label for="monitorContracts">Contracts/Shares</label>
                                <input type="number" id="monitorContracts" placeholder="1" min="1" value="1">
                            </div>
                        </div>
                        
                        <!-- Options-specific fields -->
                        <div id="optionsFields" class="input-row hidden">
                            <div class="input-group">
                                <label for="monitorStrike">Strike Price</label>
                                <input type="number" id="monitorStrike" placeholder="155.00" step="0.50">
                            </div>
                            <div class="input-group">
                                <label for="monitorExpiration">Expiration Date</label>
                                <input type="date" id="monitorExpiration">
                            </div>
                        </div>
                        
                        <!-- Risk Management -->
                        <div class="input-row">
                            <div class="input-group">
                                <label for="monitorStopLoss">Stop Loss (Optional)</label>
                                <input type="number" id="monitorStopLoss" placeholder="140.00" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="monitorTakeProfit">Take Profit (Optional)</label>
                                <input type="number" id="monitorTakeProfit" placeholder="165.00" step="0.01">
                            </div>
                            <div class="input-group">
                                <label for="monitorEmail">Alert Email (Optional)</label>
                                <input type="email" id="monitorEmail" placeholder="your@email.com">
                            </div>
                        </div>
                        
                        <button class="trade-btn enter-trade" onclick="startTradeMonitoring()">
                            üöÄ START MONITORING
                        </button>
                    </div>
                </div>
                
                <!-- Active Trades -->
                <div id="activeTradesSection" class="active-trades-section">
                    <h3>Active Positions</h3>
                    <div id="activeTradesList" class="trades-list">
                        <div class="no-trades-message">
                            <p>No active trades being monitored.</p>
                            <p>Start monitoring a position above to track real-time P/L and get exit alerts!</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Portfolio Tab -->
        <section id="portfolioTab-content" class="tab-content">
            <div class="result-card">
                <h2>üíº Portfolio Summary</h2>
                
                <!-- Portfolio Stats -->
                <div id="portfolioStats" class="portfolio-stats">
                    <div class="stat-card">
                        <div class="stat-label">Total Positions</div>
                        <div class="stat-value" id="totalPositions">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total P&L</div>
                        <div class="stat-value" id="totalPnL">$0.00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Best Performer</div>
                        <div class="stat-value" id="bestPerformer">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Worst Performer</div>
                        <div class="stat-value" id="worstPerformer">-</div>
                    </div>
                </div>
                
                <!-- Portfolio History -->
                <div id="portfolioHistory" class="portfolio-history">
                    <h3>Trading History</h3>
                    <div id="historyList" class="history-list">
                        <p class="no-history-message">No trading history available.</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- Loading Section -->
        <div id="loadingSection" class="loading-section hidden">
            <div class="loading-spinner"></div>
            <p id="loadingMessage">Loading market data...</p>
        </div>

        <!-- Error Section -->
        <div id="errorSection" class="error-section hidden">
            <div class="error-card">
                <h3>‚ö†Ô∏è Error</h3>
                <p id="errorMessage">Something went wrong. Please try again.</p>
                <button class="retry-btn" onclick="hideError()">Dismiss</button>
            </div>
        </div>

        <!-- Footer -->
        <footer class="footer">
            <p>‚ö†Ô∏è <strong>Disclaimer:</strong> Educational purposes only. Not financial advice. Trade at your own risk.</p>
            <p class="version-info">v2.0 - Advanced Trading Platform with Real-time Monitoring</p>
        </footer>
    </div>

    <!-- JavaScript -->
    <script>
        // Global state
        let currentTab = 'dashboard';
        let marketStatus = null;
        let socket = null;
        let activeMonitoringTrades = new Set();
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeApp();
        });
        
        async function initializeApp() {
            try {
                showLoading('Initializing advanced trading platform...');
                
                // Initialize WebSocket connection
                initializeWebSocket();
                
                // Load market status
                await loadMarketStatus();
                
                // Setup interface based on market hours
                setupInterfaceMode();
                
                // Load portfolio data
                await loadPortfolioSummary();
                
                // Setup form handlers
                setupFormHandlers();
                
                hideLoading();
                
                console.log('Advanced trading platform initialized successfully');
            } catch (error) {
                console.error('Initialization error:', error);
                showError('Failed to initialize platform: ' + error.message);
            }
        }
        
        function initializeWebSocket() {
            try {
                socket = io();
                
                socket.on('connect', function() {
                    console.log('WebSocket connected');
                });
                
                socket.on('disconnect', function() {
                    console.log('WebSocket disconnected');
                });
                
                socket.on('market_status_update', function(data) {
                    updateMarketStatus(data);
                });
                
                socket.on('trade_update', function(trade) {
                    updateTradeDisplay(trade);
                });
                
            } catch (error) {
                console.warn('WebSocket initialization failed:', error);
                // Continue without WebSocket - app will still work with HTTP polling
            }
        }
        
        async function loadMarketStatus() {
            try {
                const response = await fetch('/api/enhanced-market-status');
                const data = await response.json();
                
                if (data.success) {
                    marketStatus = data.market_status;
                    updateMarketStatusDisplay(marketStatus, data.context);
                }
            } catch (error) {
                console.error('Failed to load market status:', error);
            }
        }
        
        function updateMarketStatusDisplay(status, context) {
            const statusText = document.getElementById('marketStatusText');
            const nextSession = document.getElementById('nextSessionInfo');
            const modeText = document.getElementById('modeText');
            const subtitle = document.getElementById('dynamicSubtitle');
            
            statusText.textContent = status.status_text;
            
            if (status.next_session) {
                nextSession.textContent = status.next_session;
                nextSession.style.display = 'block';
            } else {
                nextSession.style.display = 'none';
            }
            
            // Update interface mode indicator
            const modeMessages = {
                'pre_market': 'üåÖ Pre-Market Analysis Mode',
                'live_trading': 'üö® Live Trading Mode',
                'after_hours': 'üìã Planning Mode',
                'closed': '‚è∏Ô∏è Market Closed'
            };
            
            modeText.textContent = modeMessages[context.interface_mode] || 'Market Status Unknown';
            
            // Update subtitle
            const subtitles = {
                'pre_market': 'Pre-Market Analysis & Watchlist Generation',
                'live_trading': 'Live Trading with Real-time Monitoring',
                'after_hours': 'Trade Planning & Portfolio Review',
                'closed': 'Market Closed - Plan Your Next Moves'
            };
            
            subtitle.textContent = subtitles[context.interface_mode] || 'Advanced Trading Platform';
        }
        
        function setupInterfaceMode() {
            // Hide all dashboard sections first
            document.querySelectorAll('.dashboard-section').forEach(section => {
                section.classList.add('hidden');
            });
            
            if (!marketStatus) return;
            
            // Show appropriate dashboard section based on market status
            if (marketStatus.is_pre_market) {
                document.getElementById('preMarketDashboard').classList.remove('hidden');
                loadPreMarketData();
            } else if (marketStatus.is_open) {
                document.getElementById('liveTradingDashboard').classList.remove('hidden');
                loadLiveTradingData();
            } else {
                document.getElementById('afterHoursDashboard').classList.remove('hidden');
                updateNextOpenCountdown();
            }
        }
        
        async function loadPreMarketData() {
            try {
                showLoading('Scanning pre-market movers...');
                
                const response = await fetch('/api/pre-market-analysis');
                const data = await response.json();
                
                if (data.success) {
                    displayPreMarketWatchlist(data.watchlist, data.recommendations);
                } else {
                    throw new Error(data.error);
                }
                
                hideLoading();
            } catch (error) {
                console.error('Pre-market data error:', error);
                showError('Failed to load pre-market data: ' + error.message);
            }
        }
        
        function displayPreMarketWatchlist(watchlist, recommendations) {
            const container = document.getElementById('preMarketWatchlist');
            container.innerHTML = '';
            
            if (!watchlist || watchlist.length === 0) {
                container.innerHTML = '<p class="no-data-message">No significant pre-market movers found.</p>';
                return;
            }
            
            watchlist.slice(0, 8).forEach(stock => {
                const card = createWatchlistCard(stock, recommendations.find(r => r.symbol === stock.symbol));
                container.appendChild(card);
            });
        }
        
        function createWatchlistCard(stock, recommendation) {
            const card = document.createElement('div');
            card.className = 'watchlist-card';
            
            const changeClass = stock.change_percent >= 0 ? 'positive' : 'negative';
            const changeSymbol = stock.change_percent >= 0 ? '+' : '';
            
            let optionsHTML = '';
            if (recommendation && recommendation.options) {
                const opts = recommendation.options;
                optionsHTML = `
                    <div class="options-recommendation">
                        <div class="option-type">${opts.option_type}</div>
                        <div class="option-details">
                            Strike: $${opts.strike_price} | Exp: ${opts.expiration_date}
                        </div>
                        <div class="option-price">Est. Premium: $${opts.estimated_premium}</div>
                    </div>
                `;
            }
            
            card.innerHTML = `
                <div class="stock-header">
                    <div class="stock-symbol">${stock.symbol}</div>
                    <div class="stock-price">$${stock.current_price}</div>
                </div>
                <div class="stock-change ${changeClass}">
                    ${changeSymbol}${stock.change_percent.toFixed(2)}% (${changeSymbol}$${stock.change.toFixed(2)})
                </div>
                <div class="stock-volume">
                    Vol: ${stock.volume.toLocaleString()} (${stock.volume_ratio.toFixed(1)}x avg)
                </div>
                <div class="technical-signals">
                    ${stock.technical.signals.slice(0, 2).join(', ')}
                </div>
                <div class="sentiment-indicator sentiment-${stock.sentiment.sentiment}">
                    ${stock.sentiment.sentiment.toUpperCase()} sentiment
                </div>
                ${optionsHTML}
                <button class="analyze-stock-btn" onclick="analyzeStock('${stock.symbol}')">
                    Analyze ${stock.symbol}
                </button>
            `;
            
            return card;
        }
        
        // Tab switching
        function switchTab(tabName) {
            // Update active tab button
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // Update active content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + 'Tab-content').classList.add('active');
            
            currentTab = tabName;
            
            // Load tab-specific data
            if (tabName === 'portfolio') {
                loadPortfolioSummary();
            } else if (tabName === 'monitor') {
                loadActiveTradesForMonitor();
            }
        }
        
        // Utility functions
        function showLoading(message = 'Loading...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingSection').classList.remove('hidden');
        }
        
        function hideLoading() {
            document.getElementById('loadingSection').classList.add('hidden');
        }
        
        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorSection').classList.remove('hidden');
        }
        
        function hideError() {
            document.getElementById('errorSection').classList.add('hidden');
        }
        
        // Placeholder functions for features to be implemented
        async function performAdvancedAnalysis() {
            const ticker = document.getElementById('analysisTickerInput').value.toUpperCase().trim();
            const budget = document.getElementById('analysisBudgetInput').value;
            
            if (!ticker) {
                showError('Please enter a stock ticker symbol');
                return;
            }
            
            try {
                showLoading(`Analyzing ${ticker} with advanced indicators...`);
                
                const response = await fetch('/api/daily-trade-finder', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ticker, budget: budget ? parseFloat(budget) : null})
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayAnalysisResults(data);
                } else {
                    throw new Error(data.error);
                }
                
                hideLoading();
            } catch (error) {
                console.error('Analysis error:', error);
                showError('Analysis failed: ' + error.message);
            }
        }
        
        function displayAnalysisResults(data) {
            const container = document.getElementById('analysisResults');
            container.classList.remove('hidden');
            
            // Implementation will be added as we continue...
            container.innerHTML = `
                <div class="analysis-summary">
                    <h3>Analysis Results for ${data.ticker}</h3>
                    <p>Current Price: $${data.current_price}</p>
                    <p>RSI: ${data.technical.rsi}</p>
                    <p>Technical Signals: ${data.technical.signals.join(', ')}</p>
                    ${data.options_recommendation ? `
                        <h4>Options Recommendation</h4>
                        <p>${data.options_recommendation.option_type} - Strike: $${data.options_recommendation.strike_price}</p>
                        <p>Estimated Premium: $${data.options_recommendation.estimated_premium}</p>
                    ` : ''}
                </div>
            `;
        }
        
        async function loadPortfolioSummary() {
            try {
                const response = await fetch('/api/portfolio-summary');
                const data = await response.json();
                
                if (data.success) {
                    updatePortfolioDisplay(data.summary, data.active_trades);
                }
            } catch (error) {
                console.error('Portfolio load error:', error);
            }
        }
        
        function updatePortfolioDisplay(summary, trades) {
            document.getElementById('totalPositions').textContent = summary.total_trades;
            document.getElementById('totalPnL').textContent = `$${summary.total_pnl}`;
            document.getElementById('bestPerformer').textContent = summary.best_performer ? 
                `${summary.best_performer.symbol} (${summary.best_performer.pnl_percent}%)` : '-';
            document.getElementById('worstPerformer').textContent = summary.worst_performer ? 
                `${summary.worst_performer.symbol} (${summary.worst_performer.pnl_percent}%)` : '-';
        }
        
        // More implementation will be added...
        
        function setupFormHandlers() {
            // Option type change handler
            document.getElementById('monitorOptionType').addEventListener('change', function() {
                const optionsFields = document.getElementById('optionsFields');
                if (this.value === 'CALL' || this.value === 'PUT') {
                    optionsFields.classList.remove('hidden');
                } else {
                    optionsFields.classList.add('hidden');
                }
            });
        }
        
        async function startTradeMonitoring() {
            const data = {
                symbol: document.getElementById('monitorSymbol').value.toUpperCase(),
                option_type: document.getElementById('monitorOptionType').value,
                entry_price: parseFloat(document.getElementById('monitorEntryPrice').value),
                contracts: parseInt(document.getElementById('monitorContracts').value),
                strike_price: document.getElementById('monitorStrike').value || null,
                expiration_date: document.getElementById('monitorExpiration').value || null,
                stop_loss: document.getElementById('monitorStopLoss').value || null,
                take_profit: document.getElementById('monitorTakeProfit').value || null,
                user_email: document.getElementById('monitorEmail').value || null
            };
            
            if (!data.symbol || !data.entry_price) {
                showError('Symbol and entry price are required');
                return;
            }
            
            try {
                showLoading('Starting trade monitoring...');
                
                const response = await fetch('/api/start-trade-monitoring', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear form
                    document.getElementById('monitorSymbol').value = '';
                    document.getElementById('monitorEntryPrice').value = '';
                    // ... clear other fields
                    
                    // Refresh active trades
                    await loadActiveTradesForMonitor();
                    
                    // Subscribe to real-time updates for this trade
                    if (socket) {
                        socket.emit('subscribe_trade_updates', {trade_id: result.trade_id});
                    }
                } else {
                    throw new Error(result.error);
                }
                
                hideLoading();
            } catch (error) {
                console.error('Trade monitoring error:', error);
                showError('Failed to start monitoring: ' + error.message);
            }
        }
        
        async function loadActiveTradesForMonitor() {
            // Implementation for loading and displaying active trades
            console.log('Loading active trades for monitor...');
        }
        
    </script>
</body>
</html>